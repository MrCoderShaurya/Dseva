<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Management</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f3f4f6;
            padding: 10px;
        }
        @media (max-width: 768px) {
            body { padding: 5px; }
            .header { padding: 8px; gap: 8px; }
            .header label { font-size: 12px; }
            .header input { width: 55px; padding: 6px 8px; font-size: 13px; }
            .save-btn { padding: 6px 14px; font-size: 12px; }
            .table-container { font-size: 10px; }
            table { font-size: 10px; }
            th, td { padding: 5px 6px; }
            .name-cell { min-width: 90px; font-size: 10px; }
            select { padding: 3px 4px; font-size: 10px; }
            input[type="text"] { padding: 3px 4px; font-size: 10px; }
            input[type="checkbox"] { width: 14px; height: 14px; }
            .popup { padding: 20px 30px; }
            .popup-icon { font-size: 36px; }
            .popup-text { font-size: 14px; }
        }
        .header {
            background: white;
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .header label { 
            font-weight: 600; 
            font-size: 14px;
            color: #374151;
        }
        .header input {
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            width: 80px;
        }
        .save-btn {
            margin-left: auto;
            padding: 8px 24px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
        }
        .save-btn:hover { background: #059669; }
        
        .table-container {
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 10px 12px;
            text-align: left;
        }
        th {
            background: #f9fafb;
            color: #374151;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .team-row {
            background: #fef3c7;
            font-weight: 600;
            color: #92400e;
        }
        .name-cell {
            background: #fafafa;
            font-weight: 500;
            min-width: 150px;
        }
        
        select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            font-size: 13px;
            background: white;
        }
        select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        input[type="text"] {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            font-size: 13px;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #3b82f6;
        }
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            padding: 30px 40px;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
            transition: transform 0.3s;
        }
        .popup.show { transform: translate(-50%, -50%) scale(1); }
        .popup-icon { font-size: 48px; margin-bottom: 10px; }
        .popup-text { font-size: 18px; font-weight: 600; color: #374151; }
        .overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        .overlay.show { display: block; }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>
    <div class="popup" id="popup">
        <div class="popup-icon" id="popupIcon">âœ“</div>
        <div class="popup-text" id="popupText">Saved Successfully!</div>
    </div>
    
    <div class="header">
        <label>Day:</label>
        <input type="number" id="dayInput" min="1" max="31" value="1">
        <button class="save-btn" onclick="saveAll()">ðŸ’¾ SAVE</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>SA</th>
                    <th>SB</th>
                    <th>MA</th>
                    <th>In DK</th>
                    <th>Comment</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        const options = ['', 'P', 'A', 'L1', 'L2', 'L3', 'L4', 'L5', 'L5+', 'Home', 'Health', 'Seva', 'WR', 'E', 'P*', 'S', 'H'];
        let members = [];
        let changes = [];

        // Auto-load current day
        fetch('/get_current_day')
            .then(r => r.json())
            .then(data => document.getElementById('dayInput').value = data.day);

        fetch('/get_all_members')
            .then(r => r.json())
            .then(data => {
                members = data;
                render();
            });

        function render() {
            const tbody = document.getElementById('tableBody');
            const teams = [...new Set(members.map(m => m.team))];
            
            tbody.innerHTML = '';
            teams.forEach(team => {
                const teamMembers = members.filter(m => m.team === team);
                
                // Team header row
                const teamRow = document.createElement('tr');
                teamRow.innerHTML = `<td colspan="6" class="team-row">${team} Team</td>`;
                tbody.appendChild(teamRow);
                
                // Member rows
                teamMembers.forEach(m => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="name-cell">${m.name}</td>
                        <td><select onchange="track(${m.index},'sa',this.value)">${options.map(o=>`<option value="${o}">${o||'-'}</option>`).join('')}</select></td>
                        <td><select onchange="track(${m.index},'sb',this.value)">${options.map(o=>`<option value="${o}">${o||'-'}</option>`).join('')}</select></td>
                        <td><select onchange="track(${m.index},'ma',this.value)">${options.map(o=>`<option value="${o}">${o||'-'}</option>`).join('')}</select></td>
                        <td><input type="checkbox" onchange="track(${m.index},'in_dk',this.checked)"></td>
                        <td><input type="text" placeholder="Comment" onchange="track(${m.index},'comment',this.value)"></td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        function track(idx, field, val) {
            changes.push({person_idx: idx, field, value: val});
        }

        function saveAll() {
            const day = document.getElementById('dayInput').value;
            if (!changes.length) {
                showPopup('âš ï¸', 'No changes', '#f59e0b');
                return;
            }
            
            showPopup('â³', 'Saving...', '#3b82f6');
            
            fetch('/update_attendance', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({day: parseInt(day), updates: changes})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showPopup('âœ“', 'Saved Successfully!', '#10b981');
                    changes = [];
                } else {
                    showPopup('âœ—', 'Save Failed', '#ef4444');
                }
            })
            .catch(() => showPopup('âœ—', 'Error Occurred', '#ef4444'));
        }

        function showPopup(icon, text, color) {
            const popup = document.getElementById('popup');
            const overlay = document.getElementById('overlay');
            document.getElementById('popupIcon').textContent = icon;
            document.getElementById('popupText').textContent = text;
            popup.style.color = color;
            
            overlay.classList.add('show');
            popup.classList.add('show');
            
            if (icon !== 'â³') {
                setTimeout(() => {
                    popup.classList.remove('show');
                    overlay.classList.remove('show');
                }, 2000);
            }
        }
    </script>
</body>
</html>
